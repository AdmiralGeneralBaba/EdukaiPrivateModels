import random
import PyPDF2
from EducationModels.openai_calls import OpenAI
import json
import os
import re

# This method regexs out the curly brackets so it only outputs the string that GPT-4 generates. 
def extract_first_content_within_curly_brackets(input_string: str):
    pattern = r'{(.*?)}'
    match = re.search(pattern, input_string)
    return match.group(1) if match else None

# This method returns the string output given a txt name from the 'prompts' folder.
def load_prompts(filename):
    module_dir = os.path.dirname(__file__)
    file_path = os.path.join(module_dir, 'prompts', filename)
    with open(file_path, 'r') as file:
        return file.read()

              
def create_assess_validity_question(pages) : 
    llm = OpenAI()
    temp = 1
    prompt = load_prompts("assess_validity.txt")
    assess_question = llm.open_ai_gpt4_call(pages, prompt, temp)
    assess_question_output = extract_first_content_within_curly_brackets(assess_question)
    return assess_question_output

def create_to_what_extent_question(pages) : 
    llm = OpenAI()
    temp = 1
    prompt = load_prompts("to_what_extent.txt")
    assess_question = llm.open_ai_gpt4_call(pages, prompt, temp)
    assess_question_output = extract_first_content_within_curly_brackets(assess_question)
    return assess_question_output
def create_how_far_question(pages) : 
    llm = OpenAI()
    temp = 1
    prompt = load_prompts("how_far.txt")
    assess_question = llm.open_ai_gpt4_call(pages, prompt, temp)
    assess_question_output = extract_first_content_within_curly_brackets(assess_question)
    return assess_question_output

#Calls the question creation methods based on probabilities of it showing up in an actual exam paper (based on it's distribution in the past)

def create_weighted_random_question(pages) : 
    rand_num = random.uniform(0, 1)
    if rand_num <= 0.35 : 
        question = create_assess_validity_question(pages)
    elif 0.35 <= rand_num <=0.85 :
        question = create_to_what_extent_question(pages)
    else :
        question = create_how_far_question(pages)
    return question

test_pages = """ ['15 economic developments 146\nThe economy under Lenin 14 6\nThe economy under Stalin 150\nSummary 156\n16 Leninist/Stalinist Society 157\nClass issues  157\nThe effects of social change on women 159\nYoung people  161\nReligion  162\nNational minorities 163\nPropaganda  164\nCultural change 165\nSummary  167\n17 communist control and Terror 168\nFaction and opposition in the 1920s 168\nOpposition to Stalin and the purges 170\nSummary 177\n18 The Soviet union by 1941 178\nThe political condition of the Soviet Union 178\nEconomic and social position 180\nThe Soviet Union by June 1941 182\nSummary 183\nSecTIOn 4\nThe Stalinist dictatorship and reaction,  \n1941–1964  184\n19 Stalinism in wartime 184\nRussia at war: political authority and opposition  185\nThe political, economic and social impact of the war 188\nThe effect of war on Stalin, the government and the people 193\nSummary 194\n20 political authority 1945–53 195\nPolitical authority and government to 1953 –  \nHigh Stalinism  195\nThe revival of Terror and the destruction of  ‘supposed opposition’  198\nStalin’s cult of personality after 1945 201\nThe power vacuum on Stalin’s death 202\nSummary 20221  Khrushchev and reaction to Stalinism,  \n1953–64 203\nKhrushchev’s rise to power 203\nPolicies and ideology, and de-Stalinisation 205\nPolitical and Party change 207\nSummary 208\n22 economic and social developments 209\nIndustrial development 209\nResults of industrial change 212\nDevelopments in agriculture 213\nSocial developments 216\nThe quality of life and cultural change  218\nSummary 220\n23 Opposition and the fall of Khrushchev 221\nOpposition from cultural dissidents 2 21\nOpposition from within the Party – hardliners  \nand reformers 223\nKhrushchev’s fall from power 225\nSummary 227\n24 The Soviet union by 1964 228\nThe political condition of the Soviet Union 228\nThe economic condition of the Soviet Union 229\nThe social condition of the Soviet Union 230\nSummary 231\nconclusion 232\nGlossary 234\nBibliography 236\nIndex 237\nContents  (continued)\niv\n835467 AQA AS History TR  FM.indd   4 24/04/2015   09:22', '1\nPart One\n1\n1 The Russian autocracy in 1855Trying to preserve  \nautocracy, 1855–1894Autocracy, reform and revolution: Russia 1855–1917\n1EXTRACT 1\nThe Russian Empire was deeply divided between the government and the Tsar’s \nsubjects; between the capital and the provinces; between the educated and the uneducated; between Western and Russian ideas; between the rich and the poor; between privilege and oppression; between contemporary fashion and centuries-old custom. Most people (and over 90 per cent of the Emperor’s subjects were born and bred in the countryside) felt that a chasm divided them from the world inhabited by the ruling elites. Russia was an empire, but national consciousness was only patchily developed and local traditions and loyalties retained the greatest influence. National consciousness was not a dominant sentiment among Russians. Except in times of war, most of them were motivated by Christian belief, peasant customs, village loyalties and reverence for the Tsar rather than by feelings of Russian nationhood. Christianity itself was a divisive phenomenon; Russian Orthodox teachings were not accepted universally. But the Tsar and the Church hierarchy wanted obedience and they had the authority to secure just that.\nAdapted from Robert Service, History of Modern Russia, 1997\nThe well-respected modern historian Robert Service has painted a picture of tsarist Russia as it was in the mid-nineteenth century and was to remain, scarcely changed, until the end of tsarist rule in 1917. His account of the state of the Russian Empire stresses its geographic, social, intellectual, economic and even religious divisions. Above all, he emphasises the localism of Russian society and the lack of national consciousness. The empire he describes seems to be held together by a ‘reverence for the Tsar’ , and by the power of that Tsar and the Russian Orthodox Church to demand obedience.\nThe political context\nIn 1855, Russia was an autocratic empire . At its head was a Tsar, who took the \ntitle ‘Emperor and Autocrat of all Russia’ . According to the ‘Collected Laws of the Russian Empire’ compiled by Tsar Nicholas I in 1832, ‘The Emperor of all the Russias is an autocratic and unlimited monarch; God himself ordains that all must bow to his supreme power, not only out of fear but also out of conscience. ’\nA Clos ER look\nEmpire \nAn empire is made up of a number of lesser states ruled over by one monarch. Nineteenth-century Russia was a vast empire of around 21 million square kilometres, twice the size of Europe and a sixth of the globe’s surface. It had been acquired through military conquest and colonisation, and was still growing.lEARNING o BJECTIVE s\nIn this chapter you will learn about:\n• the powers of the Tsar of Russia in \nthe mid-nineteenth century\n• the way in which Russia was governed and the problems the rulers faced\n• the economic state of Russia in c1855\n• the social make-up of Russia in c1855.\nkEy TERm\nlocalism: loyalty to the local \ncommunity or local area\nACTIVIT y\nAs you read this chapter, see if you can find evidence that agrees with Service’s interpretation in Extract 1.  Later in the chapter, you will be asked to assess how convincing his argument is. \nkEy TERm\nAutocratic: autocracy means having \nno limits on a ruler’s power; such a ruler was called an autocrat\nkEy QuE sTIoN\nAs you read this chapter, consider the following Key Question:How was Russia governed and how did political authority change and develop?\n835467 AQA AS History TR  Ch01.indd   1 24/04/2015   09:29\n15 economic developments 146\nThe economy under Lenin 14 6\nThe economy under Stalin 150\nSummary 156\n16 Leninist/Stalinist Society 157\nClass issues  157\nThe effects of social change on women 159\nYoung people  161\nReligion  162\nNational minorities 163\nPropaganda  164\nCultural change 165\nSummary  167\n17 communist control and Terror 168\nFaction and opposition in the 1920s 168\nOpposition to Stalin and the purges 170\nSummary 177\n18 The Soviet union by 1941 178\nThe political condition of the Soviet Union 178\nEconomic and social position 180\nThe Soviet Union by June 1941 182\nSummary 183\nSecTIOn 4\nThe Stalinist dictatorship and reaction,  \n1941–1964  184\n19 Stalinism in wartime 184\nRussia at war: political authority and opposition  185\nThe political, economic and social impact of the war 188\nThe effect of war on Stalin, the government and the people 193\nSummary 194\n20 political authority 1945–53 195\nPolitical authority and government to 1953 –  \nHigh Stalinism  195\nThe revival of Terror and the destruction of  ‘supposed opposition’  198\nStalin’s cult of personality after 1945 201\nThe power vacuum on Stalin’s death 202\nSummary 20221  Khrushchev and reaction to Stalinism,  \n1953–64 203\nKhrushchev’s rise to power 203\nPolicies and ideology, and de-Stalinisation 205\nPolitical and Party change 207\nSummary 208\n22 economic and social developments 209\nIndustrial development 209\nResults of industrial change 212\nDevelopments in agriculture 213\nSocial developments 216\nThe quality of life and cultural change  218\nSummary 220\n23 Opposition and the fall of Khrushchev 221\nOpposition from cultural dissidents 2 21\nOpposition from within the Party – hardliners  \nand reformers 223\nKhrushchev’s fall from power 225\nSummary 227\n24 The Soviet union by 1964 228\nThe political condition of the Soviet Union 228\nThe economic condition of the Soviet Union 229\nThe social condition of the Soviet Union 230\nSummary 231\nconclusion 232\nGlossary 234\nBibliography 236\nIndex 237\nContents  (continued)\niv\n835467 AQA AS History TR  FM.indd   4 24/04/2015   09:22', 'section 1  |  Trying to preserve autocracy, 1855–1894\n2RUS SIAN EMPIRE\nMONGOLIA\nCHINA\nAFGHANIST ANMANCHURIA\nPERSIAPOLAND\nMoscowWarsaw\nTehranBlack SeaCaspian\nSeaAral\nSea\nKabulBeijing\nOTTOMAN\n       EMPIRE\nThe Russian Empire in 1855Key N\nFig. 1  The Russian Empire in 1 855. What can be learned from this map about the \nlikely problems of governing Russia in the mid-nineteenth century?\nNicholas’ statement is a reminder that the Tsar was, in name only, also the Head of the Russian Orthodox Church and was regarded by Orthodox believers as the embodiment of God on Earth. The vast lands of the Russian Empire were his private property and the Russian people were his children. Russians were taught to show devotion to their Tsar and to accept their conditions on Earth as the will of God. The Patriarch of Moscow, who worked in close harmony with the Tsar, provided spiritual guidance, while the Over-Procurator  of the Holy \nSynod , a post created in 1721, was a government minister appointed by the Tsar \nto run Church affairs. This meant that the structures of Church and State were entwined, as archbishops and bishops at the head of the Church hierarchy were subject to tsarist control over appointments, religious education, most of the Church’s finances and issues of administration.\nThe Tsar’s imperial edicts (ukazy in Russian) were the law of the land. The \nTsar did, of course, have advisers and ministers, but these were all chosen by the Tsar himself and no-one could do anything without the Tsar’s approval. His main advisory bodies were the Imperial Council or Chancellery, a body of 35 to 60 nobles specially picked by the Tsar to advise him personally and provide their ‘expert’ opinion; the Council of Ministers, a body of 8 to 14 ministers in charge of different government departments; and the Senate, which was supposed to oversee all the workings of government but in practice was largely redundant by 1855.\nThe Tsar and the central government were based in the Imperial capital \nof St Petersburg but the regime also depended on the provincial nobility for support. Nobles had not been obliged to serve the State since 1785, although many continued to do so, for example as a provincial governor of one of the Empire’s fifty provinces. However, their sense of obligation remained strong and all landowners were expected to keep order on their estates. Furthermore, when circumstances demanded, Tsars might choose to appoint a special committee to carry out an investigation or prepare a report. Such committees were usually headed by trusted nobles but, even so, there was no need for the Tsar to take any notice of their findings.\nThe civil servants who made up the bureaucracy were paid noble officials, \nselected from a ‘table of ranks’ that laid down the requirements for office. key teRm\northodox church: following a split \nin the Christian Church in the eleventh century, the Eastern Orthodox Church had developed its own beliefs and rituals; in 1 453, when Constantinople fell to the Turks, Moscow became its spiritual capital\nover-Procurator: appointed by the \nTsar from the laity, this was the highest Church official\nHoly s ynod: a group of bishops, \nwhich forms the ruling body of the Orthodox Church; it is the highest authority on rules, regulations, faith and matters of Church organisation\nedict: (Russian: ukaz ) an official order \nissued by a person of authority\nA clos eR look\nProblems of governing  \nthe empire \nMany different ethnic groups lived \nwithin the Russian Empire, each with their own culture, customs, language and, in some cases, religion. Less than half the total population of around 69 million people in 1855 was Russian, and three quarters of the total population lived within European Russia – to the west of the Urals – on less than a quarter of the total land mass.\nkey teRm\nProvincial: living away from the capital\ncRoss- ReFeRence \nOne example of the special committees appointed by the Tsar is the committee of nobles that were formed to discuss the issue of Emancipation, or freeing the serfs. This is discussed in Chapter 2. key teRm\ncivil servant: someone working for \nthe government\nBureaucracy: a system of \ngovernment in which most of the important decisions are taken by state officials rather than by elected representatives\nconscription: compulsory enlistment \nof a person into military service\nserf: a person who was the property \nof the lord for whom he or she worked; serfs and serfdom are further discussed later in this chapter (on page 4, in A closer look: What was serfdom?) and will be covered in detail in Chapter 2 \nmilitary colony: where the conscripts \nlived (with their families) and trained, all under strict military discipline\nPolice state: a state in which the \nactivities of the people are closely monitored and controlled for political reasons\n835467 AQA AS History TR  Ch01.indd   2 24/04/2015   09:29']"""

print(create_assess_validity_question(test_pages))

#problems : 
    # 1. need to regex the output of the models,then add on at the end the text to accompany the 'view' or output GPT made - 30 mins
    # 2. need to make it asynchronous so it runs them all at the same time - 30 mins to 1 hour 
    # 3. need to make it ONLY extract a maximum of two pages from the 'start_num'. In other words, have it have a cap of two above the 'start_num' to be convereted from it's PDF form. 
    # 3. Need to start to learn langchain to make the creation of these things more efficient. 
